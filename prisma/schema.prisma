generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String          @id @default(cuid())
  email           String          @unique
  cpf             String          @unique
  name            String
  password        String
  emailVerified   Boolean         @default(false)
  globalRole      GlobalRole      @default(USER)
  
  companyUsers    CompanyUser[]
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@map("users")
}

model Company {
  id              String          @id @default(cuid())
  name            String
  email           String
  phone           String
  cnpj            String?         @unique
  description     String?
  
  address         Address?
  companyUsers    CompanyUser[]
  subscriptions   Subscription[]
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@map("companies")
}

model CompanyUser {
  id              String          @id @default(cuid())
  role            CompanyRole     @default(USER)
  
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String
  company         Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId       String
  
  @@unique([userId, companyId])
  @@map("company_users")
}

model Address {
  id              String          @id @default(cuid())
  street          String
  number          String
  neighborhood    String
  city            String
  state           String
  zipCode         String          @map("zip_code")
  complement      String?
  
  company         Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId       String          @unique
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@map("addresses")
}

model Subscription {
  id                      String              @id @default(cuid())
  status                  SubscriptionStatus  @default(PENDING)
  currentPeriodStart      DateTime?
  currentPeriodEnd        DateTime?
  cancelAtPeriodEnd       Boolean             @default(false)
  stripeSubscriptionId    String?             @unique
  stripeCustomerId        String?             @unique
  stripePriceId           String?
  
  company                 Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId               String
  plan                    Plan                @relation(fields: [planId], references: [id], onDelete: Cascade)
  planId                  String
  invoices                Invoice[]
  
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt

  @@map("subscriptions")
}

model Plan {
  id              String          @id @default(cuid())
  name            String
  description     String?
  price           Int            
  currency        String          @default("BRL")
  interval        PlanInterval    @default(MONTHLY)
  active          Boolean         @default(true)
  stripePriceId   String?         @unique
  stripeProductId String?
  
  subscriptions   Subscription[]
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@map("plans")
}

model Invoice {
  id              String          @id @default(cuid())
  amount          Int
  currency        String          @default("BRL")
  status          InvoiceStatus   @default(DRAFT)
  dueDate         DateTime?
  paidAt          DateTime?
  stripeInvoiceId String?         @unique
  stripePaymentIntentId String?
  
  subscription    Subscription    @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  subscriptionId  String
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@map("invoices")
}

model WebhookEvent {
  id              String          @id @default(cuid())
  type            String
  payload         Json
  processed       Boolean         @default(false)
  processingError String?
  createdAt       DateTime        @default(now())

  @@map("webhook_events")
}

enum GlobalRole {
  SUPER_ADMIN
  USER
}

enum CompanyRole {
  ADMIN
  USER
}

enum SubscriptionStatus {
  PENDING
  ACTIVE
  CANCELED
  EXPIRED
  PAYMENT_FAILED
  PAST_DUE
}

enum PlanInterval {
  MONTHLY
  HALF_YEARLY
  YEARLY
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
}
